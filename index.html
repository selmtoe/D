<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン大富豪 v2</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #004d40; /* 深い緑 */
            color: #E0E0E0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .screen { display: none; }
        .active { display: block; }

        .container {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        
        #game-screen {
            max-width: 1200px;
        }

        h1, h2 {
            color: #004d40;
        }

        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            background-color: #00796b; /* ティールグリーン */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #004d40; }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .game-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e0f2f1;
            border-radius: 5px;
        }

        .game-status-icons {
            font-size: 32px;
            display: flex;
            gap: 15px;
        }
        
        .players-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            min-height: 120px; /* 高さを調整 */
        }

        .player-box {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            width: 150px; /* 幅を調整 */
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255,255,255,0.7);
        }
        .player-box.is-turn {
            border-color: #00796b;
            box-shadow: 0 0 10px #00796b;
            font-weight: bold;
        }
        .other-player-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            margin-top: 5px;
        }
        .card-back {
            width: 12px;
            height: 18px;
            background-color: #666;
            border: 1px solid white;
            border-radius: 2px;
        }


        .field {
            border: 2px dashed #ccc;
            min-height: 150px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            background-color: rgba(0,0,0,0.1);
        }

        .my-hand-container {
            background-color: rgba(224, 242, 241, 0.9);
            padding: 15px;
            border-radius: 10px;
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .card {
            border: 1px solid #999;
            border-radius: 5px;
            width: 70px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            background-color: white;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding: 5px;
            box-sizing: border-box;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            color: #333;
        }
        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 6px 10px #00796b;
            border-color: #00796b;
        }
        .card.red { color: red; }
        .card.joker { background-color: #f0f0f0; }

        .controls {
            margin-top: 20px;
        }

        #room-info {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

    </style>
</head>
<body>

    <div id="login-screen" class="container screen active">
        <h1>オンライン大富豪</h1>
        <input type="text" id="name-input" placeholder="名前を入力してください">
        <button id="login-button">決定</button>
    </div>

    <div id="room-screen" class="container screen">
        <h1>ルーム選択</h1>
        <p>ようこそ、<span id="player-name-display"></span>さん</p>
        <button id="create-room-button">ルームを作成する</button>
        <hr style="margin: 20px 0;">
        <input type="text" id="room-id-input" placeholder="ルームIDを入力">
        <button id="join-room-button">ルームに参加する</button>
    </div>

    <div id="game-screen" class="container screen">
        <div class="game-info-bar">
            <div>
                <h2>大富豪</h2>
                <span id="turn-info"></span>
            </div>
            <div class="game-status-icons">
                 <span id="revolution-icon" title="革命中" style="display:none;">⚔️</span>
                 <span id="j-back-icon" title="Jバック中" style="display:none;">J</span>
                 <span id="reverse-icon" title="リバース中" style="display:none;">🔄</span>
            </div>
        </div>
        
        <div id="players-container" class="players-container"></div>
        
        <h3>場 (<span id="last-player-info"></span>)</h3>
        <div id="field" class="field"></div>
        
        <div class="my-hand-container">
             <h3>あなたの手札 (<span id="my-name"></span>)</h3>
             <div id="my-hand" class="card-container"></div>
        </div>

        <div id="controls" class="controls">
            <button id="play-button" disabled>出す</button>
            <button id="pass-button" disabled>パス</button>
        </div>
        
        <div id="game-controls">
             <button id="start-game-button" style="display: none; background-color: #28a745;">ゲーム開始</button>
        </div>

        <div id="room-info"></div>
    </div>

    <script type="module">
        // ▼▼▼ ここにFirebaseの設定を貼り付け ▼▼▼
        const firebaseConfig = {
    apiKey: "AIzaSyD1YdTMESZi-ynMzS_p_hdtr1znBI64RmM",
    authDomain: "daifugo-8e039.firebaseapp.com",
    projectId: "daifugo-8e039",
    storageBucket: "daifugo-8e039.firebasestorage.app",
    messagingSenderId: "979025215319",
    appId: "1:979025215319:web:1bf381daf1eb647760c812",
    measurementId: "G-KSQ8LRN4ZE"
  };
        // ▲▲▲ ここまで ▲▲▲

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentPlayer = { id: null, name: null };
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let selectedCards = [];

        // DOM Elements
        const screens = { login: document.getElementById('login-screen'), room: document.getElementById('room-screen'), game: document.getElementById('game-screen') };
        const nameInput = document.getElementById('name-input');
        const loginButton = document.getElementById('login-button');
        const playerNameDisplay = document.getElementById('player-name-display');
        const createRoomButton = document.getElementById('create-room-button');
        const joinRoomButton = document.getElementById('join-room-button');
        const roomIdInput = document.getElementById('room-id-input');
        const myHandDiv = document.getElementById('my-hand');
        const playersContainerDiv = document.getElementById('players-container');
        const fieldDiv = document.getElementById('field');
        const turnInfoSpan = document.getElementById('turn-info');
        const lastPlayerInfoSpan = document.getElementById('last-player-info');
        const roomInfoDiv = document.getElementById('room-info');
        const startGameButton = document.getElementById('start-game-button');
        const playButton = document.getElementById('play-button');
        const passButton = document.getElementById('pass-button');
        const myNameSpan = document.getElementById('my-name');
        const revolutionIcon = document.getElementById('revolution-icon');
        const jBackIcon = document.getElementById('j-back-icon');
        const reverseIcon = document.getElementById('reverse-icon');

        // --- Screen Navigation ---
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        // --- Login ---
        loginButton.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                currentPlayer.name = name;
                currentPlayer.id = generatePlayerId();
                playerNameDisplay.textContent = name;
                showScreen('room');
            } else {
                alert('名前を入力してください。');
            }
        });
        
        // --- Room Creation/Joining ---
        createRoomButton.addEventListener('click', async () => {
            currentRoomId = generateRoomId();
            const roomRef = doc(db, 'rooms', currentRoomId);
            const newPlayer = { id: currentPlayer.id, name: currentPlayer.name, isHost: true, hand: [], order: -1 };
            await setDoc(roomRef, {
                id: currentRoomId,
                players: [newPlayer],
                gameState: 'waiting',
                field: [],
                lastPlayed: { player: null, cards: [] },
                turnPlayerId: null,
                passCount: 0,
                isRevolution: false,
                isJBackActive: false,
                turnDirection: 1, // 1 for normal, -1 for reverse
                createdAt: serverTimestamp()
            });
            joinRoom(currentRoomId);
        });

        joinRoomButton.addEventListener('click', async () => {
            const roomId = roomIdInput.value.trim();
            if (!roomId) return alert('ルームIDを入力してください。');
            const roomRef = doc(db, 'rooms', roomId);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) return alert('指定されたルームが見つかりません。');
            const roomData = roomSnap.data();
            if (roomData.players.find(p => p.name === currentPlayer.name)) return alert('同じ名前のプレイヤーが既にルームにいます。');
            if (roomData.players.length >= 6) return alert('このルームは満員です。');
            if (roomData.gameState !== 'waiting') return alert('このゲームは既に開始されています。');

            const newPlayer = { id: currentPlayer.id, name: currentPlayer.name, isHost: false, hand: [], order: -1 };
            await updateDoc(roomRef, { players: arrayUnion(newPlayer) });
            joinRoom(roomId);
        });

        function joinRoom(roomId) {
            currentRoomId = roomId;
            myNameSpan.textContent = currentPlayer.name;
            showScreen('game');
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(doc(db, 'rooms', currentRoomId), (doc) => {
                if (doc.exists()) renderGame(doc.data());
                else { alert('ルームが削除されました。'); location.reload(); }
            });
        }
        
        // --- Game Start ---
        startGameButton.addEventListener('click', async () => {
            const roomRef = doc(db, 'rooms', currentRoomId);
            await runTransaction(db, async (transaction) => {
                const roomSnap = await transaction.get(roomRef);
                const roomData = roomSnap.data();

                if (roomData.players.length < 3) throw new Error('3人以上でゲームを開始できます。');

                const suits = ['spade', 'heart', 'diamond', 'club'];
                let deck = [];
                suits.forEach(s => { for (let i = 1; i <= 13; i++) deck.push({ suit: s, number: i }); });
                deck.push({ suit: 'joker', number: 15 });
                deck.push({ suit: 'joker', number: 15 });
                deck = deck.sort(() => Math.random() - 0.5);

                let players = [...roomData.players].sort(() => Math.random() - 0.5);
                
                let dia3PlayerId = null;
                players.forEach(p => p.hand = []);
                let pIndex = 0;
                while (deck.length > 0) {
                    const card = deck.pop();
                    players[pIndex].hand.push(card);
                    if (card.suit === 'diamond' && card.number === 3) dia3PlayerId = players[pIndex].id;
                    pIndex = (pIndex + 1) % players.length;
                }
                
                const firstPlayerId = dia3PlayerId || players[0].id;
                const firstPlayerIndex = players.findIndex(p => p.id === firstPlayerId);
                const sortedPlayers = [];
                for (let i = 0; i < players.length; i++) {
                    const p = players[(firstPlayerIndex + i) % players.length];
                    p.order = i + 1;
                    sortedPlayers.push(p);
                }
                
                sortedPlayers.forEach(p => p.hand.sort((a, b) => getCardStrength(a) - getCardStrength(b)));
                
                transaction.update(roomRef, {
                    players: sortedPlayers,
                    gameState: 'playing',
                    turnPlayerId: firstPlayerId,
                    field: [],
                    passCount: 0,
                    lastPlayed: { player: null, cards: [] },
                    isRevolution: false,
                    isJBackActive: false,
                    turnDirection: 1
                });
            }).catch(error => alert(error.message));
        });

        // --- Game Actions ---
        playButton.addEventListener('click', async () => {
            if (selectedCards.length === 0) return;
            const roomRef = doc(db, 'rooms', currentRoomId);

            try {
                await runTransaction(db, async (transaction) => {
                    const roomSnap = await transaction.get(roomRef);
                    if (!roomSnap.exists()) throw new Error("Room does not exist.");
                    const roomData = roomSnap.data();

                    const me = roomData.players.find(p => p.id === currentPlayer.id);
                    const validation = isValidPlay(selectedCards, me.hand, roomData);
                    if (!validation.valid) throw new Error(validation.message);

                    const newHand = me.hand.filter(c => !selectedCards.some(s => c.suit === s.suit && c.number === s.number));
                    const playersCopy = roomData.players.map(p => p.id === me.id ? { ...p, hand: newHand } : p);

                    let nextState = {
                        players: playersCopy,
                        field: selectedCards,
                        passCount: 0,
                        lastPlayed: { player: me.id, cards: selectedCards },
                        isRevolution: roomData.isRevolution,
                        isJBackActive: roomData.isJBackActive,
                        turnDirection: roomData.turnDirection,
                        turnPlayerId: roomData.turnPlayerId,
                    };
                    
                    const playedNumber = selectedCards.find(c => c.suit !== 'joker')?.number;
                    
                    // --- Card Effects ---
                    let clearField = false;
                    let skipTurn = false;

                    // Revolution
                    if (selectedCards.length >= 4) nextState.isRevolution = !nextState.isRevolution;
                    
                    // J-Back
                    if (playedNumber === 11) nextState.isJBackActive = !nextState.isJBackActive;
                    
                    // 4-Reverse
                    if (playedNumber === 4 && selectedCards.length % 2 !== 0) nextState.turnDirection *= -1;
                    
                    // Spade 3 on single Joker
                    if (selectedCards.length === 1 && playedNumber === 3 && selectedCards[0].suit === 'spade' &&
                        roomData.field.length === 1 && roomData.field[0].suit === 'joker') clearField = true;
                    
                    // 8-Giri
                    if (playedNumber === 8) clearField = true;
                    
                    // 6 or 9 (2+ cards)
                    if ((playedNumber === 6 || playedNumber === 9) && selectedCards.length >= 2) clearField = true;

                    if (clearField) {
                        nextState.field = [];
                        nextState.passCount = 0;
                        nextState.turnPlayerId = me.id; // Turn goes to the person who cleared
                        nextState.isJBackActive = false; // J-Back effect ends
                    } else if (playedNumber === 5) { // 5-Skip
                        const n = selectedCards.length;
                        const skipCount = (2*n - 1);
                        nextState.turnPlayerId = getNextPlayerId(roomData.players, me.id, nextState.turnDirection, skipCount);
                    } else {
                        nextState.turnPlayerId = getNextPlayerId(roomData.players, me.id, nextState.turnDirection, 0);
                    }

                    if (newHand.length === 0) {
                        // This is a simplified win condition. A full game would need ranks etc.
                        alert(`${me.name}が上がりました！`);
                    }

                    transaction.update(roomRef, nextState);
                });
                selectedCards = [];
            } catch (error) {
                alert(error.message);
            }
        });
        
        passButton.addEventListener('click', async () => {
             const roomRef = doc(db, 'rooms', currentRoomId);
             await runTransaction(db, async (transaction) => {
                const roomSnap = await transaction.get(roomRef);
                const roomData = roomSnap.data();
                
                let newPassCount = roomData.passCount + 1;
                let newTurnPlayerId = getNextPlayerId(roomData.players, currentPlayer.id, roomData.turnDirection, 0);
                let newField = roomData.field;
                let newJBack = roomData.isJBackActive;
                
                const activePlayers = roomData.players.filter(p => p.hand.length > 0);
                if (newPassCount >= activePlayers.length - 1) {
                    newField = []; // Clear field
                    newPassCount = 0;
                    newJBack = false; // J-Back effect ends
                    newTurnPlayerId = roomData.lastPlayed.player; // Turn goes to last player
                }
                
                transaction.update(roomRef, {
                    turnPlayerId: newTurnPlayerId,
                    passCount: newPassCount,
                    field: newField,
                    isJBackActive: newJBack
                });
             });
        });

        // --- UI Rendering ---
        function renderGame(roomData) {
            roomInfoDiv.textContent = `ルームID: ${currentRoomId}` + (roomData.gameState === 'waiting' ? ` | 参加を待っています...` : '');
            
            const amIHost = roomData.players.find(p => p.id === currentPlayer.id)?.isHost;
            startGameButton.style.display = (amIHost && roomData.gameState === 'waiting') ? 'block' : 'none';

            // Status icons
            revolutionIcon.style.display = roomData.isRevolution ? 'inline' : 'none';
            jBackIcon.style.display = roomData.isJBackActive ? 'inline' : 'none';
            reverseIcon.style.display = roomData.turnDirection === -1 ? 'inline' : 'none';

            const me = roomData.players.find(p => p.id === currentPlayer.id);
            if (!me) return;

            const sortedPlayers = [...roomData.players].sort((a, b) => a.order - b.order);
            
            playersContainerDiv.innerHTML = '';
            sortedPlayers.forEach(player => {
                if (player.id !== me.id) {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-box';
                    if (player.id === roomData.turnPlayerId) playerDiv.classList.add('is-turn');
                    
                    let cardBacksHTML = '';
                    for (let i = 0; i < (player.hand ? player.hand.length : 0); i++) {
                        cardBacksHTML += '<div class="card-back"></div>';
                    }

                    playerDiv.innerHTML = `
                        <div class="player-name">${player.name}</div>
                        <div>手札: ${player.hand ? player.hand.length : 0} 枚</div>
                        <div class="other-player-cards">${cardBacksHTML}</div>
                    `;
                    playersContainerDiv.appendChild(playerDiv);
                }
            });
            
            if (me.hand) renderMyHand(me, roomData);

            fieldDiv.innerHTML = '';
            roomData.field.forEach(card => fieldDiv.appendChild(createCardElement(card)));

            const turnPlayer = roomData.players.find(p => p.id === roomData.turnPlayerId);
            turnInfoSpan.textContent = turnPlayer ? (turnPlayer.id === me.id ? "あなたのターンです" : `${turnPlayer.name} のターン`) : "---";
            
            const lastPlayer = roomData.players.find(p => p.id === roomData.lastPlayed.player);
            lastPlayerInfoSpan.textContent = lastPlayer ? `最後に出した人: ${lastPlayer.name}` : "---";

            const isMyTurn = roomData.turnPlayerId === me.id;
            playButton.disabled = !isMyTurn;
            passButton.disabled = !isMyTurn || roomData.field.length === 0;
        }
        
        function renderMyHand(me, roomData) {
            myHandDiv.innerHTML = '';
            const isMyTurn = roomData.turnPlayerId === me.id;

            me.hand.forEach(card => {
                const cardEl = createCardElement(card);
                if (isMyTurn) {
                    cardEl.addEventListener('click', () => {
                        const cardIdentifier = JSON.stringify(card);
                        const selectedIndex = selectedCards.findIndex(c => JSON.stringify(c) === cardIdentifier);
                        
                        if (selectedIndex > -1) {
                            selectedCards.splice(selectedIndex, 1);
                            cardEl.classList.remove('selected');
                        } else {
                            selectedCards.push(card);
                            cardEl.classList.add('selected');
                        }
                    });
                }
                if (selectedCards.some(sc => sc.suit === card.suit && sc.number === card.number)) {
                    cardEl.classList.add('selected');
                }
                myHandDiv.appendChild(cardEl);
            });
        }

        // --- Helper Functions ---
        function generatePlayerId() { return Math.random().toString(36).substring(2, 10); }
        function generateRoomId() { return Math.random().toString(36).substring(2, 7).toUpperCase(); }
        
        function getCardStrength(card) { // Base strength, ignoring game state
            if (card.suit === 'joker') return 99;
            let value = card.number;
            if (value <= 2) value += 13;
            return value;
        }
        
        function getCardValue(card, roomData) {
            const strengthReversed = roomData.isRevolution ^ roomData.isJBackActive; // XOR
            const baseStrength = getCardStrength(card);
            if (baseStrength === 99) return strengthReversed ? 0 : 99; // Joker
            return strengthReversed ? 16 - baseStrength : baseStrength;
        }
        
        function getNextPlayerId(players, currentId, direction, skipCount) {
            const sortedPlayers = [...players].sort((a,b) => a.order - b.order);
            const currentIndex = sortedPlayers.findIndex(p => p.id === currentId);
            
            let nextIndex = currentIndex;
            const numPlayers = sortedPlayers.length;
            
            // Apply skips + the initial move to the next player
            const totalMoves = 1 + skipCount;

            for(let i=0; i < totalMoves; i++){
                do {
                    nextIndex = (nextIndex + direction + numPlayers) % numPlayers;
                } while(sortedPlayers[nextIndex].hand.length === 0);
            }
            
            return sortedPlayers[nextIndex].id;
        }

        function createCardElement(card) {
            const el = document.createElement('div');
            el.className = 'card';
            const suitSymbols = { spade: '♠', heart: '♥', diamond: '♦', club: '♣' };
            const numberStrings = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K' };

            if (card.suit === 'joker') {
                el.classList.add('joker');
                el.innerHTML = `<span>JOKER</span><span>JOKER</span>`;
            } else {
                const suit = suitSymbols[card.suit];
                const number = numberStrings[card.number] || card.number;
                if (card.suit === 'heart' || card.suit === 'diamond') el.classList.add('red');
                el.innerHTML = `<span>${suit}</span><span>${number}</span>`;
            }
            return el;
        }
        
        function isValidPlay(playCards, myHand, roomData) {
            // Diamond 3 rule: only on the very first turn of the game
            if (roomData.field.length === 0 && roomData.lastPlayed.player === null &&
                myHand.some(c => c.suit === 'diamond' && c.number === 3)) {
                if (!playCards.some(c => c.suit === 'diamond' && c.number === 3)) {
                    return { valid: false, message: 'ゲームの最初はダイヤの3を含めて出す必要があります。' };
                }
            }
            
            // Can't win with 2s rule
            const realCards = playCards.filter(c => c.suit !== 'joker');
            const isOnly2s = realCards.every(c => c.number === 2);
            if (isOnly2s && playCards.length === myHand.length) {
                return { valid: false, message: '2 (または2とジョーカー)だけを出して上がることはできません。' };
            }

            // All cards must be the same number (or joker)
            if (realCards.length > 0 && !realCards.every(c => c.number === realCards[0].number)) {
                return { valid: false, message: '同じ数字のカードしか同時に出せません。（階段は未実装です）' };
            }
            
            // Field is empty
            if (roomData.field.length === 0) return { valid: true };

            // Special Case: Spade 3 on single Joker
            if (playCards.length === 1 && playCards[0].suit === 'spade' && playCards[0].number === 3 &&
                roomData.field.length === 1 && roomData.field[0].suit === 'joker') {
                return { valid: true };
            }

            if (playCards.length !== roomData.field.length) {
                return { valid: false, message: '場と同じ枚数のカードを出してください。' };
            }

            const playValue = getCardValue(playCards.find(c => c.suit !== 'joker') || playCards[0], roomData);
            const fieldValue = getCardValue(roomData.field.find(c => c.suit !== 'joker') || roomData.field[0], roomData);

            if (playValue <= fieldValue) {
                 return { valid: false, message: '場に出ているカードより強いカードを出してください。' };
            }
            
            return { valid: true };
        }

        // Initialize
        showScreen('login');
    </script>
</body>
</html>
